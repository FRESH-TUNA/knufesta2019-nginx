upstream knufesta2019_was {
    server knufesta2019:80  slow_start=15s;
    keepalive 512;
}

server {
    listen 80 reuseport;

    # location은 가장 긴경로로 결정된다.
    location /health/ {
      root /srv;
    }

    location / {
        # Reject requests with unsupported HTTP method
        if ($request_method !~ ^(GET|POST|HEAD|OPTIONS|PUT|DELETE)$) {
            return 405;
        }

        # Only requests matching the whitelist expectations will
        # get sent to the application server
        proxy_pass http://knufesta2019_was:80;
        
        # default 1.0
        # websocket 팔요시 1.1
        # proxy_http_version 1.1;

        # websocket 설정
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';


        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;

        # timeout 설정
        # proxied server 와 연결을 맺는데(establishing) 설정한 timeout 시간이다. 75초를 초과 할 수 없으며 디폴트 값은 60초이다.
        #proxy_connect_timeout 60;
        proxy_send_timeout 600; #WAS로 전송할때 timeout
        #proxy_read_timeout 600; #WAS로부터 읽을때 timeout
    }
}
